server { # Valkyrie Server
  listen 443 ssl;
  server_name valkyrie.crescentcode.net;
  add_header Strict-Transport-Security "max-age=31536000; includeSubDomains";
  lua_code_cache ${{CODE_CACHE}};

  ssl on;
  ssl_certificate /etc/letsencrypt/live/valkyrie.crescentcode.net/fullchain.pem;
  ssl_certificate_key /etc/letsencrypt/live/valkyrie.crescentcode.net/privkey.pem;

  ssl_stapling on;
  ssl_stapling_verify on;

  ssl_session_timeout 1d;

  ssl_trusted_certificate /etc/letsencrypt/live/valkyrie.crescentcode.net/chain.pem;
  ssl_protocols TLSv1.2;
  ssl_prefer_server_ciphers on;
  ssl_ciphers ECDH+AESGCM:ECDH+AES256:ECDH+AES128:ECDH+3DES:RSA+AES:RSA+3DES:!ADH:!AECDH:!MD5:!DSS;
  ssl_dhparam dhparams.pem;

  location / {
    set $_url "";
    default_type text/html;
    content_by_lua_block {
      require "lfs".chdir "/root/valkyrie_server";
      require("lapis").serve("app")
    }
  }

  location /static/ {
    alias /root/valkyrie_server/static/;
  }

  location /favicon.ico {
    alias /root/valkyrie_server/static/favicon.ico;
  }

  location /proxy {
    internal;
    rewrite_by_lua "
      local req = ngx.req

      for k,v in pairs(req.get_headers()) do
        if k ~= 'content-length' then
          req.clear_header(k)
        end
      end

      if ngx.ctx.headers then
        for k,v in pairs(ngx.ctx.headers) do
          req.set_header(k, v)
        end
      end
    ";

    proxy_http_version 1.1;
    proxy_pass $_url;
    resolver 8.8.8.8;
  }
}
